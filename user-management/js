class MasterLayout extends HTMLElement {
  constructor() {
    super();
    const shadowRoot = this.attachShadow({ mode: 'open' });
    
    // Add Bootstrap CSS and icons
    const bootstrapCSS = document.createElement('link');
    bootstrapCSS.rel = 'stylesheet';
    bootstrapCSS.href = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css';
    
    const bootstrapIcons = document.createElement('link');
    bootstrapIcons.rel = 'stylesheet';
    bootstrapIcons.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css';
    
    // Add component CSS
    const componentCSS = document.createElement('link');
    componentCSS.rel = 'stylesheet';
    componentCSS.href = new URL('./master-layout.css', import.meta.url).href;

    // Fallback styles
    const fallbackStyles = document.createElement('style');
    fallbackStyles.textContent = `
      :host {
        display: block;
        font-family: 'Segoe UI', Arial, sans-serif;
      }
      .sidebar {
        background-color: #003ead;
        color: white;
      }
      .nav-link {
        color: white !important;
      }
    `;

    // Build HTML structure
    shadowRoot.innerHTML = `
      <!-- Top Navigation -->
      <header class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
          <button class="navbar-toggler sidebar-toggler" type="button">
            <span class="navbar-toggler-icon"></span>
          </button>
          
          <a class="navbar-brand" href="#">
            <img src="/images/plus-logo.png" alt="PLUS HIGHWAYS" height="40">
          </a>
          
          <div class="ms-auto d-flex align-items-center">
            <div class="dropdown">
              <a href="#" class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle" id="dropdownUser">
                <img src="/images/profile-icon.png" alt="Profile" width="32" height="32" class="rounded-circle me-2">
                <span>Admin</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">Profile</a></li>
                <li><a class="dropdown-item" href="#">Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#">Sign out</a></li>
              </ul>
            </div>
          </div>
        </div>
      </header>

      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" href="#">
              <i class="bi bi-speedometer2"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <i class="bi bi-people"></i> User Management
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <i class="bi bi-cash-coin"></i> Toll Rates
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <i class="bi bi-car-front"></i> License Plate Entry/Exit
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <i class="bi bi-camera-video"></i> CCTV Streaming
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <i class="bi bi-cloud-sun"></i> Weather Data
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <i class="bi bi-exclamation-triangle"></i> Emergency Alerts
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <i class="bi bi-cone"></i> Congestion Alerts
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <i class="bi bi-life-preserver"></i> SOS Emergency
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <i class="bi bi-shield-check"></i> Vehicle Verifications
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <i class="bi bi-chat-left-text"></i> Inquiry Reply
            </a>
          </li>
        </ul>
      </div>

      <!-- Main Content -->
      <div class="main-content" id="mainContent">
        <header>
          <h1>Admin Portal</h1>
        </header>
        <main>
          <slot></slot>
        </main>
        <footer>
          <p>Copyright Â© ${new Date().getFullYear()} PLUS HIGHWAYS SDN. BHD.</p>
        </footer>
      </div>
    `;

    // Inject styles
    shadowRoot.prepend(fallbackStyles);
    shadowRoot.prepend(componentCSS);
    shadowRoot.prepend(bootstrapIcons);
    shadowRoot.prepend(bootstrapCSS);

    // Initialize Bootstrap components
    this._initBootstrap();
  }

  _initBootstrap() {
    // Initialize dropdown
    const dropdownElement = this.shadowRoot.querySelector('.dropdown-toggle');
    if (dropdownElement) {
      new bootstrap.Dropdown(dropdownElement);
    }

    // Toggle sidebar
    const toggler = this.shadowRoot.querySelector('.sidebar-toggler');
    const sidebar = this.shadowRoot.getElementById('sidebar');
    
    toggler.addEventListener('click', () => {
      sidebar.classList.toggle('show');
    });

    // Close sidebar when clicking outside
    document.addEventListener('click', (event) => {
      if (window.innerWidth < 992 && 
          !sidebar.contains(event.target) && 
          !toggler.contains(event.target)) {
        sidebar.classList.remove('show');
      }
    });
  }
}

customElements.define('master-layout', MasterLayout);