<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PLUS â€” My Profile</title>
  <link rel="icon" type="image/x-icon" href="../images/plus-logo.ico">

  <link rel="stylesheet" href="../lib/master-layout.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
</head>

<body>
  <!-- Top Navigation -->
  <header class="navbar navbar-expand-lg navbar-dark bg-light fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="../images/plus-logo.png" alt="PLUS HIGHWAYS" height="40" />
      </a>

      <div class="ms-auto d-flex align-items-center">
        <div class="dropdown">
          <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle"
            id="dropdownUser" data-bs-toggle="dropdown">
            <img src="../images/profile-icon.png" alt="Profile" width="32" height="32" class="rounded-circle me-2" />
            <span>Admin</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="profile-info.html">Profile</a></li>
            <li>
              <hr class="dropdown-divider" />
            </li>
            <li><a class="dropdown-item" href="#">Sign out</a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <ul class="nav flex-column">
      <li class="nav-item"><a class="nav-link" href="../user-management/user-management.html"><i
            class="bi bi-people"></i> User Management</a></li>
      <li class="nav-item"><a class="nav-link" href="../toll-rates/toll-rates.html"><i class="bi bi-cash-coin"></i> Toll
          Rates</a></li>
      <li class="nav-item"><a class="nav-link" href="../license-plate-entry-exit/license-plate-entry-exit.html"><i
            class="bi bi-car-front"></i> License Plate Entry/Exit</a></li>
      <li class="nav-item"><a class="nav-link" href="../cctv-streaming/cctv-streaming.html"><i
            class="bi bi-camera-video"></i> CCTV Streaming</a></li>
      <li class="nav-item"><a class="nav-link" href="../weather-data/weather-data.html"><i class="bi bi-cloud-sun"></i>
          Weather Data</a></li>
      <li class="nav-item"><a class="nav-link" href="../emergency-alerts/emergency-alerts.html"><i
            class="bi bi-exclamation-triangle"></i> Emergency Alerts</a></li>
      <li class="nav-item"><a class="nav-link" href="../congestion-alerts/congestion-alerts.html"><i
            class="bi bi-cone"></i> Congestion Alerts</a></li>
      <li class="nav-item"><a class="nav-link" href="../sos-emergency/sos-emergency.html"><i
            class="bi bi-life-preserver"></i> SOS Emergency</a></li>
      <li class="nav-item"><a class="nav-link" href="../vehicle-verifications/vehicle-verifications.html"><i
            class="bi bi-shield-check"></i> Vehicle Verifications</a></li>
      <li class="nav-item"><a class="nav-link" href="../inquiry-reply/inquiry-reply.html"><i
            class="bi bi-chat-left-text"></i> Inquiry Reply</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <h1>Profile Information</h1>
    <p>Welcome to the PLUS HIGHWAYS administration portal</p>

    <form>
      <!-- Email (always read-only) -->
      <div class="form-group row">
        <label for="staticEmail" class="col-sm-2 col-form-label">Email</label>
        <div class="col-sm-10" style="width: 250px;">
          <input type="text" readonly class="form-control-plaintext" id="staticEmail" value="" />
        </div>
      </div>
      <div style="padding-bottom: 10px"></div>

      <!-- Full Name -->
      <div class="form-group row">
        <label for="inputFullName" class="col-sm-2 col-form-label">Full Name</label>
        <div class="col-sm-10" style="width: 250px;">
          <input type="text" class="form-control" id="inputFullName" placeholder="" disabled />
        </div>
      </div>
      <div style="padding-bottom: 10px"></div>

      <!-- Gender -->
      <div class="form-group row">
        <label class="col-sm-2 col-form-label">Gender</label>
        <div class="col-sm-10 d-flex align-items-center">
          <div class="form-check me-3">
            <input class="form-check-input" type="radio" name="gender" id="genderMale" value="Male" disabled />
            <label class="form-check-label" for="genderMale">Male</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="Female" disabled />
            <label class="form-check-label" for="genderFemale">Female</label>
          </div>
        </div>
      </div>
      <div style="padding-bottom: 10px"></div>

      <!-- Branch -->
      <div class="form-group row">
        <label for="inputBranch" class="col-sm-2 col-form-label">Branch</label>
        <div class="col-sm-10" style="width: 250px;">
          <select class="form-select" id="inputBranch" disabled>
            <option selected disabled>Select Branch</option>
          </select>
        </div>
      </div>
      <div style="padding-bottom: 10px"></div>

      <!-- Buttons -->
      <div class="mt-3">
        <button id="toggleEditBtn" class="btn btn-primary">Edit Profile</button>
        <button id="toggleSaveBtn" class="btn btn-success">Save Changes</button>
      </div>
    </form>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    console.log("Loading admin data...");

    import { initializeFirebase } from '../lib/firebase_init.js';

    document.addEventListener('DOMContentLoaded', async () => {
      const toggleEditBtn = document.getElementById('toggleEditBtn');
      const toggleSaveBtn = document.getElementById('toggleSaveBtn');

      const inputFullName = document.getElementById('inputFullName');
      const inputBranch = document.getElementById('inputBranch');
      const emailField = document.getElementById('staticEmail');
      const genderRadios = document.getElementsByName('gender');

      let firebaseDataLoaded = false;

      toggleSaveBtn.style.display = 'none';

      function setInputsDisabled(disabled) {
        inputFullName.disabled = disabled;
        inputBranch.disabled = disabled;
        genderRadios.forEach(r => r.disabled = disabled);
      }

      async function loadBranchOptions(selectedBranch = '') {
        try {
          const { db } = await initializeFirebase();
          const snapshot = await db.collection("tollBooth").get();

          const uniqueLocations = new Set();
          snapshot.forEach(doc => {
            const location = doc.data().location;
            if (location) uniqueLocations.add(location);
          });

          // Clear and populate select
          inputBranch.innerHTML = `<option disabled ${selectedBranch ? '' : 'selected'}>Select Branch</option>`;
          [...uniqueLocations].sort().forEach(location => {
            const option = document.createElement("option");
            option.value = location;
            option.textContent = location;
            if (location === selectedBranch) option.selected = true;
            inputBranch.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading branch options:", error);
          alert("Failed to load branch list.");
        }
      }

      async function loadAdminDataOnce() {
        if (firebaseDataLoaded) return;

        try {
          const { db } = await initializeFirebase();
          const docRef = db.collection('admins').doc('admin_001');
          const doc = await docRef.get();
          console.log("Admin doc data:", doc.data());

          if (!doc.exists) {
            alert("Admin not found.");
            return;
          }

          const data = doc.data();
          emailField.value = data.emailAddress || '';
          inputFullName.value = data.fullName || '';

          if (data.gender === 'Male') {
            document.getElementById('genderMale').checked = true;
          } else if (data.gender === 'Female') {
            document.getElementById('genderFemale').checked = true;
          }

          await loadBranchOptions(data.branch);

          setInputsDisabled(true);
          firebaseDataLoaded = true;
        } catch (err) {
          console.error("Failed to load data:", err);
          alert("Could not load profile.");
        }
      }

      async function saveAdminData() {
        const selectedGender = [...genderRadios].find(r => r.checked)?.value || '';
        const fullName = inputFullName.value.trim();
        const branch = inputBranch.value;

        // Validation for Full Name
        if (!fullName) {
          alert("Full Name is required.");
          inputFullName.focus();
          return;
        }

        try {
          const { db } = await initializeFirebase();
          const docRef = db.collection('admins').doc('admin_001');
          await docRef.update({
            fullName: fullName,
            gender: selectedGender,
            branch: branch,
          });

          alert("Profile updated.");
          setInputsDisabled(true);
          toggleEditBtn.style.display = 'inline-block';
          toggleSaveBtn.style.display = 'none';
        } catch (err) {
          console.error("Failed to save:", err);
          alert("Error saving changes.");
        }
      }

      toggleEditBtn.addEventListener('click', (e) => {
        e.preventDefault();
        setInputsDisabled(false);
        toggleEditBtn.style.display = 'none';
        toggleSaveBtn.style.display = 'inline-block';
      });

      toggleSaveBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await saveAdminData();
      });

      await loadAdminDataOnce();
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.querySelector('.sidebar-toggler')?.addEventListener('click', function () {
      document.getElementById('sidebar').classList.toggle('show');
    });

    document.addEventListener('click', function (event) {
      const sidebar = document.getElementById('sidebar');
      const toggler = document.querySelector('.sidebar-toggler');

      if (window.innerWidth < 992 &&
        !sidebar.contains(event.target) &&
        !toggler.contains(event.target)) {
        sidebar.classList.remove('show');
      }
    });
  </script>
</body>

</html>