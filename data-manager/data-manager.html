<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PLUS HIGHWAYS Admin Portal</title>

    <link rel="stylesheet" href="../lib/master-layout.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
<!-- Top Navigation -->
<header class="navbar navbar-expand-lg navbar-dark bg-light fixed-top">
    <div class="container-fluid">
        <button class="navbar-toggler sidebar-toggler d-lg-none me-2" type="button" style="display: none;">
            <span class="navbar-toggler-icon"></span>
        </button>

        <a class="navbar-brand" href="#">
            <img src="../images/plus-logo.png" alt="PLUS HIGHWAYS" height="40">
        </a>

        <div class="ms-auto d-flex align-items-center">
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="dropdownUser" data-bs-toggle="dropdown">
                    <img src="../images/profile-icon.png" alt="Profile" width="32" height="32" class="rounded-circle me-2">
                    <span>Admin</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="../user-management/profile-info.html">Profile</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#">Sign out</a></li>
                </ul>
            </div>
        </div>
    </div>
</header>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="nav-link" href="../user-management/user-management.html">
                <i class="bi bi-people"></i> User Management
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="../toll-rates/toll-rates.html">
                <i class="bi bi-cash-coin"></i> Toll Rates
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="../license-plate-entry-exit/license-plate-entry-exit.html">
                <i class="bi bi-car-front"></i> License Plate Entry/Exit
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="../cctv-streaming/cctv-streaming.html">
                <i class="bi bi-camera-video"></i> CCTV Streaming
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="../weather-data/weather-data.html">
                <i class="bi bi-cloud-sun"></i> Weather Data
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="../emergency-alerts/emergency-alerts.html">
                <i class="bi bi-exclamation-triangle"></i> Emergency Alerts
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="../congestion-alerts/congestion-alerts.html">
                <i class="bi bi-cone"></i> Congestion Alerts
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="../sos-emergency/sos-emergency.html">
                <i class="bi bi-life-preserver"></i> SOS Emergency
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="../vehicle-verifications/vehicle-verifications.html">
                <i class="bi bi-shield-check"></i> Vehicle Verifications
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="../inquiry-reply/inquiry-reply.html">
                <i class="bi bi-chat-left-text"></i> Inquiry Reply
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="../data-manager/data-manager.html">
                <i class="bi bi-table"></i> Data Manager
            </a>
        </li>
        </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <h1>Data Manager</h1>
            <p>Maintain some CRUDs of certain variable.</p>
        
            <!-- Your page content will go here -->
            <div class="container-fluid">
                <!-- Content rows/columns -->
        
                <table class="table table-bordered table-striped w-auto" id="branchTable">
                    <thead>
                        <tr>
                            <th width="200px">Branch Name</th>
                            <th width="200px">Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <script>
            import { initializeFirebase } from '/lib/firebase_init.js';
        
            async function loadBranchTable() {
                try {
                    const { db } = await initializeFirebase();
                    const snapshot = await db.collection("tollBooth").get();

                    const uniqueLocations = new Map(); // store docId with location
                    snapshot.forEach(doc => {
                        const location = doc.data().location;
                        if (location) uniqueLocations.set(doc.id, location);
                    });

                    const tableBody = document.querySelector("#branchTable tbody");
                    tableBody.innerHTML = ""; // clear table first

                    uniqueLocations.forEach((location, docId) => {
                        const row = document.createElement("tr");

                        const nameCell = document.createElement("td");
                        nameCell.textContent = location;

                        const actionCell = document.createElement("td");
                        const deleteBtn = document.createElement("button");
                        deleteBtn.textContent = "Delete";
                        deleteBtn.onclick = () => deleteBranch(docId);

                        actionCell.appendChild(deleteBtn);
                        row.appendChild(nameCell);
                        row.appendChild(actionCell);

                        tableBody.appendChild(row);
                    });
                } catch (error) {
                    // console.error("Error loading branch list:", error);
                    // alert("Failed to load branch list.");
                }
            }

            async function deleteBranch(docId) {
                if (!confirm("Are you sure you want to delete this branch?")) return;

                try {
                    const { db } = await initializeFirebase();
                    await db.collection("tollBooth").doc(docId).delete();
                    alert("Branch deleted successfully.");
                    loadBranchTable(); // refresh table
                } catch (error) {
                    console.error("Error deleting branch:", error);
                    alert("Failed to delete branch.");
                }
            }

            // Call when page loads
            loadBranchTable();
                    
            async function deleteBranch(locationName) {
                if (!confirm(`Are you sure you want to delete branch "${locationName}"?`)) return;

                try {
                    const { db } = await initializeFirebase();
                    const snapshot = await db.collection("tollBooth")
                        .where("location", "==", locationName)
                        .get();

                    const batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    alert(`Branch "${locationName}" deleted successfully.`);
                    loadBranchOptions(); // refresh table & dropdown
                } catch (error) {
                    console.error("Error deleting branch:", error);
                    alert("Failed to delete branch.");
                }
            }

            // Call on page load
            loadBranchOptions();


        </script>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Toggle sidebar on mobile
    document.querySelector('.sidebar-toggler').addEventListener('click', function () {
        document.getElementById('sidebar').classList.toggle('show');
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function (event) {
        const sidebar = document.getElementById('sidebar');
        const toggler = document.querySelector('.sidebar-toggler');

        if (window.innerWidth < 992 &&
            !sidebar.contains(event.target) &&
            !toggler.contains(event.target)) {
            sidebar.classList.remove('show');
        }
    });
</script>
</body>
</html>